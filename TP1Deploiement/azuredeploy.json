{
  // Deployment schema for an ARM template, defining the schema version and content
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",

  // Declaration of parameters used for configuration and deployment customization
  "parameters": {
    // Configuration parameters for virtual network, network interface, and security settings
    "location": { "type": "string" },
    "osDiskType": { "type": "string" },
    "virtualNetworkId": { "type": "string" },
    "virtualNetworkName": { "type": "string" },
    "networkSecurityGroups": { "type": "array" },
    "networkInterfaceConfigurations": { "type": "array" },

    // Parameters for backend pool configuration and load balancer
    "backendPoolName": { "type": "string" },
    "loadBalancerName": { "type": "string" },
    "loadbalancingRuleFrontEndPort": { "type": "int" },
    "loadbalancingRuleBackendEndPort": { "type": "int" },
    "loadbalancingRuleProtocol": { "type": "string" },
    "InboundNATRuleFrontEndPortRangeStart": { "type": "int" },

    // VM and scale set configuration parameters
    "vmName": { "type": "string" },
    "virtualMachineScaleSetName": { "type": "string" },
    "instanceCount": { "type": "string" },
    "instanceSize": { "type": "string" },
    "zone": { "type": "array" },
    "zoneBalance": { "type": "string" },
    "platformFaultDomainCount": { "type": "string" },
    "scaleInPolicy": { "type": "object" },
    "upgradePolicy": { "type": "string" },
    "hibernationEnabled": { "type": "bool" },

    // Parameters for security configuration and admin access settings
    "adminUsername": { "type": "string" },
    "adminPassword": { "type": "secureString" },
    "customData": { "type": "secureString" },
    "securityType": { "type": "string" },
    "secureBoot": { "type": "bool" },
    "vTPM": { "type": "bool" },

    // Advanced virtual network configuration parameters
    "vnetLocation": {
      "type": "string",
      "metadata": { "description": "Azure region for the deployment, resource group and resources." },
      "defaultValue": "canadacentral"
    },
    "vnetExtendedLocation": {
      "type": "object",
      "defaultValue": {}
    },
    "vnetVirtualNetworkName": {
      "type": "string",
      "defaultValue": "vnet-canadacentral",
      "metadata": { "description": "Name of the virtual network resource." }
    },
    "vnetTagsByResource": {
      "type": "object",
      "defaultValue": {},
      "metadata": { "description": "Optional tags for the resources." }
    },
    "vnetProperties": {
      "type": "object",
      "defaultValue": {
        "subnets": [
          {
            "name": "snet-canadacentral-1",
            "properties": { "addressPrefixes": [ "172.16.0.0/24" ] }
          }
        ],
        "addressSpace": { "addressPrefixes": [ "172.16.0.0/16" ] }
      }
    },
    "vnetNatGatewaysWithNewPublicIpAddress": {
      "type": "array",
      "defaultValue": []
    },
    "vnetNatGatewaysWithoutNewPublicIpAddress": {
      "type": "array",
      "defaultValue": []
    },
    "vnetNatGatewayPublicIpAddressesNewNames": {
      "type": "array",
      "metadata": { "description": "Array of public ip addresses for NAT Gateways." },
      "defaultValue": []
    },
    "vnetNetworkSecurityGroupsNew": {
      "type": "array",
      "metadata": { "description": "Array of NAT Gateway objects for subnets." },
      "defaultValue": []
    },
    "vnetResourceGroupName": {
      "type": "string",
      "defaultValue": "TP1"
    },
    "vnetDeploymentName": {
      "type": "string",
      "defaultValue": "network-interface-associated-virtual-network-20241109164215"
    }
  },

  // Declaration of variables to simplify resource configuration
  "variables": {
    // API versions for storage, networking, and the scale set
    "storageApiVersion": "2021-01-01",
    "networkApiVersion": "2020-11-01",
    "virtualMachineScaleSetApiVersion": "2024-07-01",

    // Additional variables for naming configuration and scale set settings
    "namingInfix": "[toLower(substring(concat(parameters('virtualMachineScaleSetName'), uniqueString(resourceGroup().id)), 0, 9))]",
    "autoScaleResourceName": "[concat(substring(parameters('virtualMachineScaleSetName'), 0, min(length(parameters('virtualMachineScaleSetName')), 55)), 'autoscale')]",
    "vmssId": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('virtualMachineScaleSetName'))]",
    "standardSku": { "name": "Standard" },
    "vnetStaticAllocation": { "publicIPAllocationMethod": "Static" },
    "vnetPremiumTier": { "tier": "Premium" },
    "vnetPublicIpAddressesTags": "[if(contains(parameters('vnetTagsByResource'), 'Microsoft.Network/publicIpAddresses'), parameters('vnetTagsByResource')['Microsoft.Network/publicIpAddresses'], json('{}'))]",
    "vnetNatGatewayTags": "[if(contains(parameters('vnetTagsByResource'), 'Microsoft.Network/natGateways'), parameters('vnetTagsByResource')['Microsoft.Network/natGateways'], json('{}'))]"
  },

  // Declaration of resources to deploy with specific configurations for each component
  "resources": [
    // Network security group with a copy loop to create multiple security groups
    {
      "name": "[parameters('networkSecurityGroups')[copyIndex()].name]",
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2020-05-01",
      "location": "[parameters('location')]",
      "properties": { "securityRules": "[parameters('networkSecurityGroups')[copyIndex()].rules]" },
      "copy": {
        "name": "networkSecurityGroups",
        "count": "[length(parameters('networkSecurityGroups'))]"
      }
    },

    // Public IP address associated with the load balancer
    {
      "name": "[concat(parameters('loadBalancerName'), '-publicip')]",
      "type": "Microsoft.Network/publicIpAddresses",
      "apiVersion": "2020-08-01",
      "location": "[parameters('location')]",
      "properties": {
        "publicIpAllocationMethod": "Static",
        "publicIPAddressVersion": "IPv4",
        "idleTimeoutInMinutes": 15
      },
      "sku": { "name": "Standard" },
      "zones": [ "1", "3" ]
    },

    // Definition of the load balancer with configuration of load balancing rules, NAT, and probes
    {
      "name": "[parameters('loadBalancerName')]",
      "type": "Microsoft.Network/loadBalancers",
      "apiVersion": "2021-05-01",
      "location": "[parameters('location')]",
      "sku": { "name": "Standard" },
      "properties": {
        "frontendIPConfigurations": [
          {
            "name": "[concat(parameters('loadBalancerName'), '-frontendconfig01')]",
            "properties": { "publicIPAddress": { "id": "[resourceId('Microsoft.Network/publicIpAddresses', concat(parameters('loadBalancerName'), '-publicip'))]" } }
          }
        ],
        "backendAddressPools": [ { "name": "[parameters('backendPoolName')]" } ],
        "loadBalancingRules": [
          {
            "name": "[concat(parameters('loadBalancerName'), '-lbrule01')]",
            "properties": {
              "frontendIPConfiguration": { "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', parameters('loadBalancerName'), concat(parameters('loadBalancerName'), '-frontendconfig01'))]" },
              "backendAddressPool": { "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', parameters('loadBalancerName'), parameters('backendPoolName'))]" },
              "frontendPort": "[parameters('loadbalancingRuleFrontEndPort')]",
              "backendPort": "[parameters('loadbalancingRuleBackendEndPort')]",
              "enableFloatingIP": false,
              "idleTimeoutInMinutes": 15,
              "disableOutboundSnat": true,
              "loadDistribution": "Default",
              "protocol": "[parameters('loadbalancingRuleProtocol')]",
              "probe": { "id": "[resourceId('Microsoft.Network/loadBalancers/probes', parameters('loadBalancerName'), concat(parameters('loadBalancerName'), '-probe01'))]" }
            }
          }
        ],
        "probes": [
          {
            "name": "[concat(parameters('loadBalancerName'), '-probe01')]",
            "properties": {
              "protocol": "Tcp",
              "port": 3389,
              "intervalInSeconds": 15,
              "numberOfProbes": 2
            }
          }
        ],
        "inboundNatPools": [
          {
            "name": "[concat(parameters('loadBalancerName'), '-natpool01')]",
            "properties": {
              "frontendIPConfiguration": { "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', parameters('loadBalancerName'), concat(parameters('loadBalancerName'), '-frontendconfig01'))]" },
              "protocol": "Tcp",
              "frontendPortRangeStart": "[parameters('InboundNATRuleFrontEndPortRangeStart')]",
              "frontendPortRangeEnd": 20000,
              "backendPort": 3389
            }
          }
        ]
      },

      // Creation of VM scale set with OS configuration, image, and network connectivity settings
      {
        "name": "[parameters('virtualMachineScaleSetName')]",
        "type": "Microsoft.Compute/virtualMachineScaleSets",
        "apiVersion": "[variables('virtualMachineScaleSetApiVersion')]",
        "location": "[parameters('location')]",
        "sku": {
          "tier": "Standard",
          "name": "[parameters('instanceSize')]",
          "capacity": "[parameters('instanceCount')]"
        },
        "properties": {
          "upgradePolicy": { "mode": "[parameters('upgradePolicy')]" },
          "scaleInPolicy": "[parameters('scaleInPolicy')]",
          "virtualMachineProfile": { "networkProfile": { "networkInterfaceConfigurations": "[parameters('networkInterfaceConfigurations')]" } }
        }
      }
  ],

  // Output configuration to return information on deployed resources
  "outputs": {
    "vmssId": {
      "type": "string",
      "value": "[variables('vmssId')]"
    }
  }
}
